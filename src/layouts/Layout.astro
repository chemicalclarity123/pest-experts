---
// src/layouts/Layout.astro
// Base layout with centralized SEO management
import Navbar from '../components/Navbar.astro';
import Seo from '../components/Seo.astro';
import '../styles/global.css';

interface Props {
	title?: string;
	description?: string;
	seo?: any;
	schemaMarkup?: any | any[];
	ogImage?: string; // Legacy support
	canonicalUrl?: string; // Legacy support
}

const { 
	title, 
	description,
	seo,
	schemaMarkup,
	ogImage,
	canonicalUrl
} = Astro.props;

// Prepare SEO object from both new and legacy props
const seoData = seo || {
	metaTitle: title,
	metaDescription: description,
	shareImage: ogImage,
	canonicalUrl: canonicalUrl
};
---

<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width" />
	<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
	
	<!-- Preconnect — resuelve DNS y TLS antes de que se necesiten los recursos -->
	<link rel="preconnect" href="https://cdn.sanity.io" crossorigin />
	<link rel="dns-prefetch" href="https://cdn.sanity.io" />
	
	<Seo 
		title={title}
		description={description}
		seo={seoData}
		schemaMarkup={schemaMarkup}
	/>
	
	<!-- Preload hints — permite que cada página inyecte preloads para su LCP image -->
	<slot name="preload" />

	<!-- Additional head content -->
	<slot name="head" />

	<!-- Google Tag Manager — carga diferida hasta idle o interacción del usuario para no bloquear LCP -->
	<script is:inline>
		window.dataLayer = window.dataLayer || [];
		(function(){
			var loaded = false;
			function loadGTM() {
				if (loaded) return;
				loaded = true;
				var w=window,d=document,s='script',l='dataLayer',i='GTM-THXXJNP';
				w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
				var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
				j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
				f.parentNode.insertBefore(j,f);
				/* Limpia listeners de interacción tras cargar */
				['scroll','click','keydown','touchstart'].forEach(function(e){
					document.removeEventListener(e, loadGTM, {capture:true});
				});
			}
			/* Estrategia: idle callback (max 5s) O primera interacción del usuario */
			if ('requestIdleCallback' in window) {
				requestIdleCallback(loadGTM, {timeout: 5000});
			} else {
				setTimeout(loadGTM, 5000);
			}
			['scroll','click','keydown','touchstart'].forEach(function(e){
				document.addEventListener(e, loadGTM, {capture:true, once:true, passive:true});
			});
		})();
	</script>
</head>
<body>
	<!-- Google Tag Manager (noscript) -->
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-THXXJNP"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

	<Navbar />
	<main>
		<slot />
	</main>
	<slot name="footer" />
</body>
</html>

<!-- Estilos globales centralizados en src/styles/global.css -->
