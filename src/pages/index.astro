---
// src/pages/index.astro
// Homepage with full Sanity CMS integration
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import ServicesSection from '../components/ServicesSection.astro';
import ServiceAreasMap from '../components/ServiceAreasMap.astro';
import WhyChooseUs from '../components/WhyChooseUs.astro';
import ServicesGrid from '../components/ServicesGrid.astro';
import Testimonials from '../components/Testimonials.astro';
import FAQ from '../components/FAQ.astro';
import LeadFormCompact from '../components/LeadFormCompact.astro';
import WhatsAppWidget from '../components/WhatsAppWidget.astro';
import Footer from '../components/Footer.astro';
import { fetchHomepage, fetchServices, fetchCompanySettings, urlFor } from '../lib/sanity-client';
import { generateHomepageSchema } from '../lib/schema';

// Genera URLs de preload para que el browser descargue la imagen LCP antes del render

// Lanza las tres queries en paralelo â€” elimina la latencia en cascada
const [homepage, services, companySettings] = await Promise.all([
  fetchHomepage(),
  fetchServices(),
  fetchCompanySettings(),
]);

// Fallback data if Sanity is empty
const fallbackHomepage = {
  hero: {
    headline: "Gauteng's Trusted Pest Control",
    subheadline: "Fast, Local, Effective",
    ctaText: "Get A Quote",
    trustBadges: ["24/7 Emergency Service", "Licensed & Insured", "Free Inspection"]
  },
  serviceAreas: {
    title: "Local Areas We Serve",
    description: "Professional pest control services across Gauteng Province"
  },
  whyChooseUs: {
    title: "Why Choose Us",
    features: [
      {
        icon: "ðŸŽ¯",
        title: "Local Experts",
        description: "Based in Gauteng, we understand local pest challenges"
      },
      {
        icon: "âš¡",
        title: "Fast Response",
        description: "We respond within 1 hour to all inquiries"
      },
      {
        icon: "âœ…",
        title: "Guaranteed Results",
        description: "6-month guarantee on all treatments"
      }
    ]
  },
  testimonials: {
    title: "What Our Customers Say",
    reviews: []
  },
  faq: {
    title: "Frequently Asked Questions",
    questions: []
  }
};

const pageData = homepage || fallbackHomepage;

// Pre-calcula URLs del hero para preload en <head>
const heroImg = pageData.hero?.backgroundImage;
const hasHeroImage = heroImg && typeof heroImg === 'object' && heroImg.asset;
const preloadMobile = hasHeroImage ? urlFor(heroImg).width(640).quality(50).auto('format').url() : null;
const preloadDesktop = hasHeroImage ? urlFor(heroImg).width(1280).quality(65).auto('format').url() : null;
const preloadFull = hasHeroImage ? urlFor(heroImg).width(1440).quality(65).auto('format').url() : null;

// Get WhatsApp number from company settings
const whatsappNumber = companySettings?.contactInfo?.whatsapp || "+27123456789";

// Generate composite homepage schema with LocalBusiness + FAQ
const schemaMarkup = generateHomepageSchema({
  name: companySettings?.businessName || "Pest Experts Gauteng",
  legalName: companySettings?.legalName,
  description: pageData.seo?.metaDescription || "Professional pest control services in Gauteng. Fast response, guaranteed results. Licensed & insured pest experts.",
  url: Astro.site?.toString() || "https://pestexperts.co.za",
  logo: companySettings?.logo,
  telephone: companySettings?.contactInfo?.telephone || "+27123456789",
  email: companySettings?.contactInfo?.email || "info@pestexperts.co.za",
  address: companySettings?.address,
  geo: companySettings?.geo,
  openingHours: companySettings?.businessHours?.map((hours: any) => 
    `${hours.days} ${hours.opens}-${hours.closes}`
  ),
  priceRange: companySettings?.priceRange,
  aggregateRating: companySettings?.aggregateRating,
  review: companySettings?.googleReviews?.map((r: any) => ({
    author: r.author,
    datePublished: r.publishDate || new Date().toISOString(),
    reviewBody: r.text,
    reviewRating: {
      ratingValue: r.rating
    }
  })),
  sameAs: companySettings?.sameAs?.map((profile: any) => profile.url),
  areaServed: companySettings?.serviceAreas || companySettings?.serviceArea?.gautengAreas || ["Pretoria", "Johannesburg", "Gauteng"],
  services: services?.map((s: any) => s.title) || ["Pest Control", "Rodent Control", "Termite Control"],
  faqs: pageData.faq?.questions || []
});
---

<Layout 
  seo={pageData.seo}
  schemaMarkup={schemaMarkup}
>
  {/* Preload hero image â€” reduce LCP en ~2s al iniciar la descarga durante parsing del HTML */}
  {preloadDesktop && (
    <link
      slot="preload"
      rel="preload"
      as="image"
      href={preloadDesktop}
      imagesrcset={`${preloadMobile} 640w, ${preloadDesktop} 1280w, ${preloadFull} 1440w`}
      imagesizes="(max-width: 768px) 640px, (max-width: 1280px) 1280px, 1440px"
      fetchpriority="high"
    />
  )}
  <!-- Hero Section -->
  <Hero 
    headline={pageData.hero?.headline}
    subheadline={pageData.hero?.subheadline}
    ctaText={pageData.hero?.ctaText}
    backgroundImage={pageData.hero?.backgroundImage}
    trustBadges={pageData.hero?.trustBadges}
  />

  <!-- Services Section -->
  <ServicesSection 
    title={pageData.services?.title}
    description={pageData.services?.description}
    serviceCards={pageData.services?.serviceCards}
  />

  <!-- Service Areas Map -->
  <ServiceAreasMap 
    title={pageData.serviceAreas?.title}
    description={pageData.serviceAreas?.description}
    mapImage={pageData.serviceAreas?.mapImage}
  />

  <!-- Why Choose Us -->
  <WhyChooseUs 
    title={pageData.whyChooseUs?.title}
    features={pageData.whyChooseUs?.features}
  />

  <!-- Testimonials -->
  <Testimonials 
    title={companySettings?.testimonials?.title || pageData.testimonials?.title || "What Our Customers Say"}
    reviews={companySettings?.testimonials?.reviews}
    googleReviews={companySettings?.googleReviews}
  />
  
  <!-- FAQ Section -->
  {pageData.faq?.questions && pageData.faq.questions.length > 0 && (
    <FAQ 
      title={pageData.faq.title}
      questions={pageData.faq.questions}
    />
  )}

  <!-- Lead Form â€” variante oscura con fondo verde -->
  <section class="lead-form-section">
    <div class="lead-form-container">
      <LeadFormCompact 
        title={pageData.leadForm?.title || "Get A Free Quote"}
        description={pageData.leadForm?.description || "Fill out the form and we'll contact you within 1 hour"}
        source="homepage_bottom"
        formId="bottomForm"
        variant="dark"
        headingLevel="h2"
      />
    </div>
  </section>

  <!-- WhatsApp Widget -->
  <WhatsAppWidget 
    phoneNumber={whatsappNumber}
    message="Hi! I'd like to get a quote for pest control services in Gauteng."
  />

  <!-- Footer â€” pasa datos ya obtenidos para evitar re-fetches -->
  <Footer companyData={companySettings} servicesData={services} />
</Layout>

<style>
  .lead-form-section {
    background: #1d5f20;
    padding: 4rem 0;
  }

  .lead-form-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }
</style>
